<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Configuration syntax | ngx_waf</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="A web application firewall module for nginx without complex configuration.'">
    
    <link rel="preload" href="/ngx_waf/assets/css/0.styles.50317297.css" as="style"><link rel="preload" href="/ngx_waf/assets/js/app.782f3221.js" as="script"><link rel="preload" href="/ngx_waf/assets/js/2.765de306.js" as="script"><link rel="preload" href="/ngx_waf/assets/js/13.31f90b21.js" as="script"><link rel="prefetch" href="/ngx_waf/assets/js/10.e5175a4f.js"><link rel="prefetch" href="/ngx_waf/assets/js/11.13f84e60.js"><link rel="prefetch" href="/ngx_waf/assets/js/12.c11e7e57.js"><link rel="prefetch" href="/ngx_waf/assets/js/14.1a679090.js"><link rel="prefetch" href="/ngx_waf/assets/js/15.6d4cdfe7.js"><link rel="prefetch" href="/ngx_waf/assets/js/16.7ade88bb.js"><link rel="prefetch" href="/ngx_waf/assets/js/17.b82eee55.js"><link rel="prefetch" href="/ngx_waf/assets/js/18.585be541.js"><link rel="prefetch" href="/ngx_waf/assets/js/19.387e4f7f.js"><link rel="prefetch" href="/ngx_waf/assets/js/20.f3dc0cb0.js"><link rel="prefetch" href="/ngx_waf/assets/js/21.89dc6e87.js"><link rel="prefetch" href="/ngx_waf/assets/js/22.693df155.js"><link rel="prefetch" href="/ngx_waf/assets/js/23.2438c50d.js"><link rel="prefetch" href="/ngx_waf/assets/js/24.d9df1d40.js"><link rel="prefetch" href="/ngx_waf/assets/js/25.5b3cda8c.js"><link rel="prefetch" href="/ngx_waf/assets/js/26.a0a08fab.js"><link rel="prefetch" href="/ngx_waf/assets/js/27.1692ae8b.js"><link rel="prefetch" href="/ngx_waf/assets/js/28.6955cd66.js"><link rel="prefetch" href="/ngx_waf/assets/js/29.e35aa5fe.js"><link rel="prefetch" href="/ngx_waf/assets/js/3.28429520.js"><link rel="prefetch" href="/ngx_waf/assets/js/30.1ce809ba.js"><link rel="prefetch" href="/ngx_waf/assets/js/31.9ca332ff.js"><link rel="prefetch" href="/ngx_waf/assets/js/32.97a4d311.js"><link rel="prefetch" href="/ngx_waf/assets/js/33.b5bd0189.js"><link rel="prefetch" href="/ngx_waf/assets/js/34.59b7abe0.js"><link rel="prefetch" href="/ngx_waf/assets/js/35.717e9f22.js"><link rel="prefetch" href="/ngx_waf/assets/js/36.e0f98f9b.js"><link rel="prefetch" href="/ngx_waf/assets/js/4.e5a10528.js"><link rel="prefetch" href="/ngx_waf/assets/js/5.b1796519.js"><link rel="prefetch" href="/ngx_waf/assets/js/6.01e41ae3.js"><link rel="prefetch" href="/ngx_waf/assets/js/7.c8dbc414.js"><link rel="prefetch" href="/ngx_waf/assets/js/8.36764b10.js"><link rel="prefetch" href="/ngx_waf/assets/js/9.2f8022f4.js">
    <link rel="stylesheet" href="/ngx_waf/assets/css/0.styles.50317297.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/ngx_waf/" class="home-link router-link-active"><!----> <span class="site-name">ngx_waf</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf/advance/syntax.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf/zh-cn/advance/syntax.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Select language" class="dropdown-title"><span class="title">Languages</span> <span class="arrow down"></span></button> <button type="button" aria-label="Select language" class="mobile-dropdown-title"><span class="title">Languages</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/ngx_waf/advance/syntax.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  English
</a></li><li class="dropdown-item"><!----> <a href="/ngx_waf/zh-cn/advance/syntax.html" class="nav-link">
  简体中文
</a></li></ul></div></div> <a href="https://github.com/ADD-SP/ngx_waf/" target="_blank" rel="noopener noreferrer" class="repo-link">
    Github
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf/guide/overview.html" class="sidebar-heading clickable"><span>Quick Start</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/ngx_waf/advance/syntax.html" aria-current="page" class="sidebar-heading clickable router-link-exact-active router-link-active open active"><span>Advanced Guide</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/ngx_waf/advance/syntax.html" aria-current="page" class="active sidebar-link">Configuration syntax</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/ngx_waf/advance/syntax.html#waf" class="sidebar-link">waf</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/advance/syntax.html#waf-rule-path" class="sidebar-link">waf_rule_path</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/advance/syntax.html#waf-mode" class="sidebar-link">waf_mode</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/advance/syntax.html#waf-cc-deny" class="sidebar-link">waf_cc_deny</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/advance/syntax.html#waf-cache" class="sidebar-link">waf_cache</a></li><li class="sidebar-sub-header"><a href="/ngx_waf/advance/syntax.html#waf-priority" class="sidebar-link">waf_priority</a></li></ul></li><li><a href="/ngx_waf/advance/rule.html" class="sidebar-link">Rule Description</a></li><li><a href="/ngx_waf/advance/priority.html" class="sidebar-link">Rule Priority</a></li><li><a href="/ngx_waf/advance/variable.html" class="sidebar-link">Built-in Variables</a></li><li><a href="/ngx_waf/advance/log.html" class="sidebar-link">Log</a></li><li><a href="/ngx_waf/advance/issue.html" class="sidebar-link">Known Issues</a></li><li><a href="/ngx_waf/advance/changes.html" class="sidebar-link">Changes</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="configuration-syntax"><a href="#configuration-syntax" class="header-anchor">#</a> Configuration syntax</h1> <h2 id="waf"><a href="#waf" class="header-anchor">#</a> <code>waf</code></h2> <ul><li>syntax: waf &lt;<em>on</em> | <em>off</em>&gt;</li> <li>default: waf <em>off</em></li> <li>context: server</li></ul> <p>Whether to enable this module.</p> <h2 id="waf-rule-path"><a href="#waf-rule-path" class="header-anchor">#</a> <code>waf_rule_path</code></h2> <ul><li>syntax: waf_rule_path &lt;<em>dir</em>&gt;</li> <li>default: —</li> <li>context: server</li></ul> <p>The absolute path to the directory where the rule file is located, and must end with <code>/</code>.</p> <h2 id="waf-mode"><a href="#waf-mode" class="header-anchor">#</a> <code>waf_mode</code></h2> <ul><li>syntax: waf_mode &lt;<em>mode_type</em>&gt; ...</li> <li>default: —</li> <li>context: server</li></ul> <p>Specify the working mode of the firewall, specifying at least one mode and up to eight modes.</p> <p><code>mode_type</code> has the following values (not case sensitive):</p> <ul><li>GET: Start the inspection process when <code>Http.Method=GET</code>.</li> <li>HEAD: Start the inspection process when <code>Http.Method=HEAD</code>.</li> <li>POST: Start the inspection process when <code>Http.Method=POST</code>.</li> <li>PUT: Start the inspection process when <code>Http.Method=PUT</code>.</li> <li>DELETE: Start the inspection process when <code>Http.Method=DELETE</code>.</li> <li>MKCOL: Start the check process when <code>Http.Method=MKCOL</code>.</li> <li>COPY: Start the inspection process when <code>Http.Method=COPY</code>.</li> <li>MOVE: Start the inspection process when <code>Http.Method=MOVE</code>.</li> <li>OPTIONS: Start the inspection process when <code>Http.Method=OPTIONS</code>.</li> <li>PROPFIN: Start the inspection process when <code>Http.Method=PROPFIN</code>.</li> <li>PROPPATCH: Start the inspection process when <code>Http.Method=PROPPATCH</code>.</li> <li>LOCK: Start the inspection process when <code>Http.Method=LOCK</code>.</li> <li>UNLOCK: Start the inspection process when <code>Http.Method=UNLOCK</code>.</li> <li>PATCH: Start the inspection process when <code>Http.Method=PATCH</code>.</li> <li>TRAC: Start the inspection process when <code>Http.Method=TRAC</code>.</li> <li>IP: Enable IP address inspecting rules.</li> <li>URL: Enable URL inspecting rules.</li> <li>RBODY: Enable POST request body inspecting rules.</li> <li>ARGS: Enable ARGS inspecting rules.</li> <li>UA: Enable UA inspecting rules.</li> <li>COOKIE: Enable COOKIE inspecting rules.</li> <li>REFERER: Enable REFERER inspecting rules.</li> <li>CC: Enable 'Anti Challenge Collapsar'. When you enable this mode, you must set <a href="#waf-cc-deny">waf_cc_deny</a>.</li> <li>COMPAT: compatibility mode, used to enable compatibility options with other modules or environments, currently used for compatibility with the ngx_http_rewrite_module, see <a href="/ngx_waf/guide/compatibility.html">compatibility statement</a>.</li> <li>STRICT: Strict mode, which sacrifices some performance for more checks, currently only works when <code>COMPAT</code> mode is enabled, and performs a full round of inspections before and after the ngx_http_rewrite_module takes effect.</li> <li>CACHE: Enable caching. Enabling this mode will cache the result of the inspection, so that the next time the same target is inspected, there is no need to repeat the inspection. However, the results of the POST body inspection are not cached. For example, if a URL is not in the blacklist after inspection, the next time the same URL is inspected, the cache can be read directly. When you enable this mode, you must set <a href="#waf-cache">waf_cache</a>.</li> <li>STD: Standard working mode, equivalent to <code>HEAD GET POST IP URL RBODY ARGS UA CC COMPAT CACHE</code>.</li> <li>STATIC: working mode for static sites, equivalent to <code>HEAD GET IP URL UA CC CACHE</code>.</li> <li>DYNAMIC: working mode for dynamic sites, equivalent to <code>HEAD GET POST IP URL ARGS UA RBODY COOKIE CC COMPAT CACHE</code>.</li> <li>FULL: Enable all modes.</li></ul> <p>You can turn off a mode by prefixing a <code>mode_type</code> with <code>!</code> prefix to a <code>mode_type</code> to turn it off.
The following is an example of using the standard working mode, but without inspecting the User-Agent.</p> <div class="language-nginx extra-class"><pre class="language-nginx"><code>waf_mode STD <span class="token operator">!</span>UA<span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">NOTE</p> <p>The mode of <code>CC</code> is independent of other modes, and whether it takes effect or not is not affected by other modes. A typical situation such as the <code>URL</code> mode will be affected by the <code>GET</code> mode, because if the <code>GET</code> mode is not used, the check will not be started when <code>Http.Method=GET</code>, and the URL will naturally not be inspected, but <code>CC</code> mode will not be similarly affected.</p></div> <h2 id="waf-cc-deny"><a href="#waf-cc-deny" class="header-anchor">#</a> <code>waf_cc_deny</code></h2> <ul><li>syntax: waf_cc_deny &lt;rate=<em>n</em>r/m&gt; [duration=<em>1h</em>] [size=<em>20m</em>]</li> <li>default: —</li> <li>context: server</li></ul> <p>Set the parameters related to CC protection.</p> <ul><li><code>rate</code>: Indicates the maximum number of requests per minute, e.g. <code>60r/m</code> means the maximum number of requests per minute is 60. Exceeding the limit returns a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Status/503" target="_blank" rel="noopener noreferrer">503 status code<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> with a <a href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Retry-After" target="_blank" rel="noopener noreferrer">Retry-After<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> response header.</li> <li><code>duration</code>: Indicates the time to block IP after exceeding the limit of the first parameter <code>rate</code>, such as <code>60s</code>, <code>60m</code>, <code>60h</code> and <code>60d</code>, if not specified, the default is <code>1h</code>.</li> <li><code>size</code>: Used to set the size of the memory for recording IP accesses, such as <code>20m</code>, <code>2048k</code>, must not be less than <code>20m</code>, if not specified, the default is <code>20m</code>.</li></ul> <h2 id="waf-cache"><a href="#waf-cache" class="header-anchor">#</a> <code>waf_cache</code></h2> <ul><li>syntax: waf_cache &lt;capacity=<em>n</em>&gt; [interval=<em>1h</em>] [percent=<em>50</em>]</li> <li>default: —</li> <li>context: server</li></ul> <p>Set the parameters related to cache rule inspection results.</p> <ul><li><code>capacity</code>: For some inspection items with caching mechanism enabled, the maximum number of inspection results per inspection item to be cached for each inspection target.</li> <li><code>interval</code>: Set the period of the batch cull cache in minutes, such as <code>60s</code>, <code>60m</code>, <code>60h</code> and <code>60d</code>, or <code>1h</code> if not specified. If not specified, the default is <code>1h</code>, which is one hour.</li> <li><code>percent</code>: What percentage of the cache is eliminated each time the batch eliminates the cache. Specify an integer greater than 0 and less than or equal to 100. A setting of 50 means that half of the cache is eliminated. If not specified, the default is <code>50</code>.</li></ul> <div class="custom-block tip"><p class="custom-block-title">Cache-enabled inspections</p> <p>Cache-enabled inspections refer to all inspections except CC protection, I
P black and white list inspection, and POST inspection.</p></div> <div class="custom-block tip"><p class="custom-block-title">Performance optimization suggestions</p> <p>Too small a <code>capacity</code> will result in frequent cache cleanups,
increasing memory fragmentation and reducing performance.
So please set it reasonably according to your actual needs.</p></div> <h2 id="waf-priority"><a href="#waf-priority" class="header-anchor">#</a> <code>waf_priority</code></h2> <ul><li>syntax: waf_priority &quot;<em>str</em>&quot;</li> <li>default: waf_priority &quot;W-IP B-IP CC W-URL URL ARGS UA W-REFERER REFERER COOKIE&quot;</li> <li>context: server</li></ul> <p>Set the priority of each inspection process, except for POST detection, which always has the lowest priority.</p> <ul><li><code>W-IP</code>: IP whitelist inspection</li> <li><code>IP</code>: IP Blacklist inspection</li> <li><code>CC</code>: CC protection</li> <li><code>W-URL</code>: URL whitelist inspection</li> <li><code>URL</code>: URL blacklist inspection</li> <li><code>ARGS</code>: URL parameter (query string) blacklist inspection</li> <li><code>UA</code>: User-Agent blacklist inspection</li> <li><code>W-REFERER</code>: Referer whitelist inspection</li> <li><code>REFERER</code>: Referer blacklist inspection</li> <li><code>COOKIE</code>: Cookie blacklist inspection</li></ul> <div class="custom-block warning"><p class="custom-block-title">warning</p> <p><code>str</code> must be wrapped in single or double quotes, and <code>str</code> must contain all of the inspection process.</p></div></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/ADD-SP/ngx_waf/edit/master/docs/advance/syntax.md" target="_blank" rel="noopener noreferrer">Help us improve this page!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/24/2021, 12:59:37 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/ngx_waf/guide/faq.html" class="prev">
        FAQ
      </a></span> <span class="next"><a href="/ngx_waf/advance/rule.html">
        Rule Description
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/ngx_waf/assets/js/app.782f3221.js" defer></script><script src="/ngx_waf/assets/js/2.765de306.js" defer></script><script src="/ngx_waf/assets/js/13.31f90b21.js" defer></script>
  </body>
</html>
